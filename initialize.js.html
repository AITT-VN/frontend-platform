<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: initialize.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: initialize.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * The initialization module provides a function for managing an application's initialization
 * lifecycle.  It also provides constants and default handler implementations.
 *
 * @memberof frontend-platform
 * @service Initialization
 */

import { createBrowserHistory } from 'history';
import {
  publish,
} from './pubSub';
import {
  getConfig,
} from './config';
import { configure as configureLogging, getLoggingService, NewRelicLoggingService, logError } from './logging';
import { configure as configureAnalytics, SegmentAnalyticsService, identifyAnonymousUser, identifyAuthenticatedUser } from './analytics';
import { getAuthenticatedHttpClient, configure as configureAuth, ensureAuthenticatedUser, fetchAuthenticatedUser, hydrateAuthenticatedUser, getAuthenticatedUser } from './auth';
import { configure as configureI18n } from './i18n';

/** @constant */
export const APP_TOPIC = 'APP';

export const APP_PUBSUB_INITIALIZED = `${APP_TOPIC}.PUBSUB_INITIALIZED`;

/**
 * Event published when the application initialization sequence has finished loading any dynamic
 * configuration setup in a custom config handler.
 *
 * @event
 */
export const APP_CONFIG_INITIALIZED = `${APP_TOPIC}.CONFIG_INITIALIZED`;

/**
 * Event published when the application initialization sequence has finished determining the user's
 * authentication state, creating an authenticated API client, and executing auth handlers.
 *
 * @event
 */
export const APP_AUTH_INITIALIZED = `${APP_TOPIC}.AUTH_INITIALIZED`;

/**
 * Event published when the application initialization sequence has finished initializing
 * internationalization and executing any i18n handlers.
 *
 * @event
 */
export const APP_I18N_INITIALIZED = `${APP_TOPIC}.I18N_INITIALIZED`;

/**
 * Event published when the application initialization sequence has finished initializing the
 * logging service and executing any logging handlers.
 *
 * @event
 */
export const APP_LOGGING_INITIALIZED = `${APP_TOPIC}.LOGGING_INITIALIZED`;

/**
 * Event published when the application initialization sequence has finished initializing the
 * analytics service and executing any analytics handlers.
 *
 * @event
 */
export const APP_ANALYTICS_INITIALIZED = `${APP_TOPIC}.ANALYTICS_INITIALIZED`;

/**
 * Event published when the application initialization sequence has finished.  Applications should
 * subscribe to this event and start rendering the UI when it has fired.
 *
 * @event
 */
export const APP_READY = `${APP_TOPIC}.READY`;

/**
 * Event published when the application initialization sequence has aborted.  This is frequently
 * used to show an error page when an initialization error has occurred.
 *
 * @see {@link module:React~ErrorPage}
 * @event
 */
export const APP_INIT_ERROR = `${APP_TOPIC}.INIT_ERROR`;

/**
 * A browser history object created by the [history](https://github.com/ReactTraining/history)
 * package.  Applications are encouraged to use this history object, rather than creating their own,
 * as behavior may be undefined when managing history via multiple mechanisms/instances.
 *
 * @memberof module:frontend-platform
 * @service Utilities
 */
export const history = createBrowserHistory();

/**
 * The default handler for the initialization lifecycle's `initError` phase.  Logs the error to the
 * LoggingService using `logError`
 *
 * @see {@link module:frontend-platform/logging~logError}
 * @memberof module:frontend-platform
 * @service Initialization
 * @param {*} error
 */
export async function initError(error) {
  logError(error);
}

/**
 * The default handler for the initialization lifecycle's `auth` phase.
 *
 * The handler has several responsibilities:
 * - Determining the user's authentication state (authenticated or anonymous)
 * - Optionally redirecting to login if the application requires an authenticated user.
 * - Optionally loading additional user information via the application's user account data
 * endpoint.
 *
 * @memberof module:frontend-platform
 * @service Initialization
 * @param {boolean} requireUser Whether or not we should redirect to login if a user is not
 * authenticated.
 * @param {boolean} hydrateUser Whether or not we should fetch additional user account data.
 */
export async function auth(requireUser, hydrateUser) {
  if (requireUser) {
    await ensureAuthenticatedUser(global.location.href);
  } else {
    await fetchAuthenticatedUser();
  }

  if (hydrateUser &amp;&amp; getAuthenticatedUser() !== null) {
    // We intentionally do not await the promise returned by hydrateAuthenticatedUser. All the
    // critical data is returned as part of fetch/ensureAuthenticatedUser above, and anything else
    // is a nice-to-have for application code.
    hydrateAuthenticatedUser();
  }
}


/**
 * The default handler for the initialization lifecycle's `analytics` phase.
 *
 * The handler is responsible for identifying authenticated and anonymous users with the analytics
 * service.  This is a pre-requisite for sending analytics events, thus, we do it during the
 * initialization sequence so that analytics is ready once the application's UI code starts to load.
 *
 * @memberof module:frontend-platform
 * @service Initialization
 */
export async function analytics() {
  const authenticatedUser = getAuthenticatedUser();
  if (authenticatedUser &amp;&amp; authenticatedUser.userId) {
    identifyAuthenticatedUser(authenticatedUser.userId);
  } else {
    identifyAnonymousUser();
  }
}

function applyOverrideHandlers(overrides) {
  const noOp = async () => {};
  return {
    pubSub: noOp,
    config: noOp,
    logging: noOp,
    auth,
    analytics,
    i18n: noOp,
    ready: noOp,
    initError,
    ...overrides, // This will override any same-keyed handlers from above.
  };
}

/**
 * Invokes the application initialization sequence.
 *
 * The sequence proceeds through a number of lifecycle phases, during which pertinent services are
 * configured.
 *
 * Using the `handlers` option, lifecycle phase handlers can be overridden to perform custom
 * functionality.  Note that while these override handlers _do_ replace the default handler
 * functionality for analytics, auth, and initError (the other phases have no default
 * functionality), they do _not_ override the configuration of the actual services that those
 * handlers leverage.
 *
 * Some services can be overridden via the loggingService and analyticsService options.  The other
 * services (auth and i18n) cannot currently be overridden.
 *
 * The following lifecycle phases exist:
 *
 * - pubSub: A no-op by default.
 * - config: A no-op by default.
 * - logging: A no-op by default.
 * - auth: Uses the 'auth' handler defined above.
 * - analytics: Uses the 'analytics' handler defined above.
 * - i18n: A no-op by default.
 * - ready: A no-op by default.
 * - initError: Uses the 'initError' handler defined above.
 *
 * @memberof module:frontend-platform
 * @service Initialization
 * @param {Object} [options]
 * @param {*} [options.loggingService=NewRelicLoggingService] The `LoggingService` implementation
 * to use.
 * @param {*} [options.analyticsService=SegmentAnalyticsService] The `AnalyticsService`
 * implementation to use.
 * @param {*} [options.requireAuthenticatedUser=false] If true, turns on automatic login
 * redirection for unauthenticated users.  Defaults to false, meaning that by default the
 * application will allow anonymous/unauthenticated sessions.
 * @param {*} [options.hydrateAuthenticatedUser=false] If true, makes an API call to the user
 * account endpoint (`${App.config.LMS_BASE_URL}/api/user/v1/accounts/${username}`) to fetch
 * detailed account information for the authenticated user. This data is merged into the return
 * value of `getAuthenticatedUser`, overriding any duplicate keys that already exist. Defaults to
 * false, meaning that no additional account information will be loaded.
 * @param {*} [options.messages] A i18n-compatible messages object, or an array of such objects. If
 * an array is provided, duplicate keys are resolved with the last-one-in winning.
 * @param {*} [options.handlers={}] An optional object of handlers which can be used to replace the
 * default behavior of any part of the startup sequence. It can also be used to add additional
 * initialization behavior before or after the rest of the sequence.
 */
export async function initialize({
  loggingService = NewRelicLoggingService,
  analyticsService = SegmentAnalyticsService,
  requireAuthenticatedUser: requireUser = false,
  hydrateAuthenticatedUser: hydrateUser = false,
  messages,
  handlers: overrideHandlers = {},
}) {
  const handlers = applyOverrideHandlers(overrideHandlers);
  try {
    // Pub/Sub
    await handlers.pubSub();
    publish(APP_PUBSUB_INITIALIZED);

    // Configuration
    await handlers.config();
    publish(APP_CONFIG_INITIALIZED);

    // Logging
    configureLogging(loggingService, {
      config: getConfig(),
    });
    await handlers.logging();
    publish(APP_LOGGING_INITIALIZED);

    // Authentication
    configureAuth({
      loggingService: getLoggingService(),
      appBaseUrl: getConfig().BASE_URL,
      lmsBaseUrl: getConfig().LMS_BASE_URL,
      loginUrl: getConfig().LOGIN_URL,
      logoutUrl: getConfig().LOGIN_URL,
      refreshAccessTokenEndpoint: getConfig().REFRESH_ACCESS_TOKEN_ENDPOINT,
      accessTokenCookieName: getConfig().ACCESS_TOKEN_COOKIE_NAME,
      csrfTokenApiPath: getConfig().CSRF_TOKEN_API_PATH,
    });
    await handlers.auth(requireUser, hydrateUser);
    publish(APP_AUTH_INITIALIZED);

    // Analytics
    configureAnalytics(analyticsService, {
      config: getConfig(),
      loggingService: getLoggingService(),
      httpClient: getAuthenticatedHttpClient(),
    });
    await handlers.analytics();
    publish(APP_ANALYTICS_INITIALIZED);

    // Internationalization
    configureI18n({
      messages,
      config: getConfig(),
      loggingService: getLoggingService(),
    });
    await handlers.i18n();
    publish(APP_I18N_INITIALIZED);

    // Application Ready
    await handlers.ready();
    publish(APP_READY);
  } catch (error) {
    if (!error.isRedirecting) {
      // Initialization Error
      await handlers.initError(error);
      publish(APP_INIT_ERROR, error);
    }
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><ul class="list-unstyled"><li><a href="module-frontend-platform.html">frontend-platform</a> <ul class="list-unstyled pl-3 mt-2 mb-4">
            <li class="mt-2 mb-4">
            <h6>Initialization</h6>
            <ul class="list-unstyled">
                <li><a href="module-frontend-platform.html#.analytics">analytics</a></li><li><a href="module-frontend-platform.html#.auth">auth</a></li><li><a href="module-frontend-platform.html#.initError">initError</a></li><li><a href="module-frontend-platform.html#.initialize">initialize</a></li>
            </ul>
        </li><li class="mt-2 mb-4">
            <h6>Utilities</h6>
            <ul class="list-unstyled">
                <li><a href="module-frontend-platform.html#.camelCaseObject">camelCaseObject</a></li><li><a href="module-frontend-platform.html#.convertKeyNames">convertKeyNames</a></li><li><a href="module-frontend-platform.html#.ensureDefinedConfig">ensureDefinedConfig</a></li><li><a href="module-frontend-platform.html#.getQueryParameters">getQueryParameters</a></li><li><a href="module-frontend-platform.html#.history">history</a></li><li><a href="module-frontend-platform.html#.modifyObjectKeys">modifyObjectKeys</a></li><li><a href="module-frontend-platform.html#.snakeCaseObject">snakeCaseObject</a></li>
            </ul>
        </li><li class="mt-2 mb-4">
            <h6>Config</h6>
            <ul class="list-unstyled">
                <li><a href="module-frontend-platform.html#.ConfigDocument">ConfigDocument</a></li><li><a href="module-frontend-platform.html#.ensureConfig">ensureConfig</a></li><li><a href="module-frontend-platform.html#.getConfig">getConfig</a></li><li><a href="module-frontend-platform.html#.mergeConfig">mergeConfig</a></li><li><a href="module-frontend-platform.html#.setConfig">setConfig</a></li>
            </ul>
        </li><li class="mt-2 mb-4">
            <h6>PubSub</h6>
            <ul class="list-unstyled">
                <li><a href="module-frontend-platform.html#.publish">publish</a></li><li><a href="module-frontend-platform.html#.subscribe">subscribe</a></li><li><a href="module-frontend-platform.html#.unsubscribe">unsubscribe</a></li>
            </ul>
        </li>
        </ul></li><li><a href="module-frontend-platform_analytics.html">frontend-platform/analytics</a> <ul class="list-unstyled pl-3 mt-2 mb-4">
            <li class="mt-2 mb-4">
            
            <ul class="list-unstyled">
                <li><a href="module-frontend-platform_analytics.AnalyticsService.html">AnalyticsService</a></li><li><a href="module-frontend-platform_analytics.SegmentAnalyticsService.html">SegmentAnalyticsService</a></li><li><a href="module-frontend-platform_analytics.html#~configure">configure</a></li><li><a href="module-frontend-platform_analytics.html#~getAnalyticsService">getAnalyticsService</a></li><li><a href="module-frontend-platform_analytics.html#~identifyAnonymousUser">identifyAnonymousUser</a></li><li><a href="module-frontend-platform_analytics.html#~identifyAuthenticatedUser">identifyAuthenticatedUser</a></li><li><a href="module-frontend-platform_analytics.html#~resetAnalyticsService">resetAnalyticsService</a></li><li><a href="module-frontend-platform_analytics.html#~sendPageEvent">sendPageEvent</a></li><li><a href="module-frontend-platform_analytics.html#~sendTrackEvent">sendTrackEvent</a></li><li><a href="module-frontend-platform_analytics.html#~sendTrackingLogEvent">sendTrackingLogEvent</a></li>
            </ul>
        </li>
        </ul></li><li><a href="module-frontend-platform_auth.html">frontend-platform/auth</a> <ul class="list-unstyled pl-3 mt-2 mb-4">
            <li class="mt-2 mb-4">
            
            <ul class="list-unstyled">
                <li><a href="module-frontend-platform_auth.HttpClient.html">HttpClient</a></li><li><a href="module-frontend-platform_auth.UserData.html">UserData</a></li><li><a href="module-frontend-platform_auth.html#~AUTHENTICATED_USER_TOPIC">AUTHENTICATED_USER_TOPIC</a></li><li><a href="module-frontend-platform_auth.html#~configure">configure</a></li><li><a href="module-frontend-platform_auth.html#~ensureAuthenticatedUser">ensureAuthenticatedUser</a></li><li><a href="module-frontend-platform_auth.html#~event:AUTHENTICATED_USER_CHANGED">AUTHENTICATED_USER_CHANGED</a></li><li><a href="module-frontend-platform_auth.html#~fetchAuthenticatedUser">fetchAuthenticatedUser</a></li><li><a href="module-frontend-platform_auth.html#~getAuthenticatedHttpClient">getAuthenticatedHttpClient</a></li><li><a href="module-frontend-platform_auth.html#~getAuthenticatedUser">getAuthenticatedUser</a></li><li><a href="module-frontend-platform_auth.html#~hydrateAuthenticatedUser">hydrateAuthenticatedUser</a></li><li><a href="module-frontend-platform_auth.html#~redirectToLogin">redirectToLogin</a></li><li><a href="module-frontend-platform_auth.html#~redirectToLogout">redirectToLogout</a></li><li><a href="module-frontend-platform_auth.html#~setAuthenticatedUser">setAuthenticatedUser</a></li>
            </ul>
        </li>
        </ul></li><li><a href="module-frontend-platform_i18n.html">frontend-platform/i18n</a> <ul class="list-unstyled pl-3 mt-2 mb-4">
            <li class="mt-2 mb-4">
            
            <ul class="list-unstyled">
                <li><a href="module-frontend-platform_i18n.html#.configure">configure</a></li><li><a href="module-frontend-platform_i18n.html#.findSupportedLocale">findSupportedLocale</a></li><li><a href="module-frontend-platform_i18n.html#.getCookies">getCookies</a></li><li><a href="module-frontend-platform_i18n.html#.getLocale">getLocale</a></li><li><a href="module-frontend-platform_i18n.html#.getMessages">getMessages</a></li><li><a href="module-frontend-platform_i18n.html#.getPrimaryLanguageSubtag">getPrimaryLanguageSubtag</a></li><li><a href="module-frontend-platform_i18n.html#.handleRtl">handleRtl</a></li><li><a href="module-frontend-platform_i18n.html#.isRtl">isRtl</a></li><li><a href="module-frontend-platform_i18n.html#.LOCALE_CHANGED">LOCALE_CHANGED</a></li><li><a href="module-frontend-platform_i18n.html#.LOCALE_TOPIC">LOCALE_TOPIC</a></li><li><a href="module-frontend-platform_i18n.html#.mergeMessages">mergeMessages</a></li><li><a href="module-frontend-platform_i18n.html#~defineMessages">defineMessages</a></li><li><a href="module-frontend-platform_i18n-FormattedDate.html">FormattedDate</a></li><li><a href="module-frontend-platform_i18n-FormattedMessage.html">FormattedMessage</a></li><li><a href="module-frontend-platform_i18n-FormattedMessage.html">FormattedMessage</a></li><li><a href="module-frontend-platform_i18n-FormattedNumber.html">FormattedNumber</a></li><li><a href="module-frontend-platform_i18n-FormattedPlural.html">FormattedPlural</a></li><li><a href="module-frontend-platform_i18n-FormattedRelative.html">FormattedRelative</a></li><li><a href="module-frontend-platform_i18n-FormattedTime.html">FormattedTime</a></li><li><a href="module-frontend-platform_i18n-IntlProvider.html">IntlProvider</a></li><li><a href="module-frontend-platform_i18n.html#~intlShape">intlShape</a></li>
            </ul>
        </li>
        </ul></li><li><a href="module-frontend-platform_logging.html">frontend-platform/logging</a> <ul class="list-unstyled pl-3 mt-2 mb-4">
            <li class="mt-2 mb-4">
            
            <ul class="list-unstyled">
                <li><a href="module-frontend-platform_logging.html#~configure">configure</a></li><li><a href="module-frontend-platform_logging.html#~getLoggingService">getLoggingService</a></li><li><a href="module-frontend-platform_logging.html#~logError">logError</a></li><li><a href="module-frontend-platform_logging.html#~logInfo">logInfo</a></li><li><a href="module-frontend-platform_logging.html#~resetLoggingService">resetLoggingService</a></li>
            </ul>
        </li>
        </ul></li><li><a href="module-frontend-platform_react.html">frontend-platform/react</a> <ul class="list-unstyled pl-3 mt-2 mb-4">
            <li class="mt-2 mb-4">
            
            <ul class="list-unstyled">
                <li><a href="module-frontend-platform_react.html#.AppContext">AppContext</a></li><li><a href="module-frontend-platform_react.html#.AppProvider">AppProvider</a></li><li><a href="module-frontend-platform_react.html#.AuthenticatedPageRoute">AuthenticatedPageRoute</a></li><li><a href="module-frontend-platform_react.ErrorBoundary.html">ErrorBoundary</a></li><li><a href="module-frontend-platform_react.ErrorPage.html">ErrorPage</a></li><li><a href="module-frontend-platform_react.html#.LoginRedirect">LoginRedirect</a></li><li><a href="module-frontend-platform_react.html#.OptionalReduxProvider">OptionalReduxProvider</a></li><li><a href="module-frontend-platform_react.html#.PageRoute">PageRoute</a></li><li><a href="module-frontend-platform_react.html#.useAppEvent">useAppEvent</a></li>
            </ul>
        </li>
        </ul></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Tue Dec 10 2019 20:58:00 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
